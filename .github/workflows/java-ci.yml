name: Run AI Prompt and Save Output

on:
  workflow_dispatch:  # manual trigger

permissions:
  contents: write      # allow committing output

jobs:
  run-ai:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read the prompt
        id: readprompt
        run: |
          PROMPT_CONTENT=$(cat prompt.txt)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call OpenAI API
        id: callai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESPONSE=$(curl -s https://api.githubcopilot.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [{\"role\": \"user\", \"content\": \"${{ steps.readprompt.outputs.prompt }}\"}]
            }" | jq -r '.choices[0].message.content')

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Save output to file
        run: |
          mkdir -p ai-output
          FILE="ai-output/response-$(date +'%Y-%m-%d-%H-%M-%S').md"
          echo "# Prompt" > $FILE
          echo "${{ steps.readprompt.outputs.prompt }}" >> $FILE
          echo "" >> $FILE
          echo "# Response" >> $FILE
          echo "${{ steps.callai.outputs.response }}" >> $FILE
          echo "Saved to $FILE"

      - name: Commit the output
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ai-output/
          git commit -m "AI response added"
          git push
