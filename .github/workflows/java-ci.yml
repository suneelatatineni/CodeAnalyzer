name: Copilot API POC

on:
  workflow_dispatch:

jobs:
  run-copilot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Copilot Prompt
        env:
          COPILOT_TOKEN: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Calling GitHub Copilot API..."

          PROMPT="Explain the purpose of this repository in 5 sentences."

          RAW_RESPONSE=$(curl -s https://api.githubcopilot.com/chat/completions \
            -H "Authorization: Bearer $COPILOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"user\", \"content\": \"$PROMPT\"}
              ]
            }")

          echo "Raw Response:"
          echo "$RAW_RESPONSE"

          # Extract content using jq
          RESPONSE=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content')

          echo "Saving Copilot response to copilot_output.txt..."
          echo "$RESPONSE" > copilot_output.txt

      - name: Commit Copilot Output
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"

          git add copilot_output.txt
          git commit -m "Add Copilot API response" || echo "Nothing to commit"
          git push

